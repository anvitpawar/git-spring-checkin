Awesome — here’s Step 1: updated version of parseProfileString that handles environment block grouping and tagging each line.

⸻

✅ parseProfileString — Handles:
	•	Plaintext detection (for if, elif, else, fi, etc.)
	•	Recognizes environment groups (dev, sit, uat, else)
	•	Tags key-value lines with envGroup to sync later

⸻



function parseProfileString(profileString) {
  const lines = profileString.split('\n');
  const result = [];
  let currentEnvGroup = null;

  lines.forEach((line) => {
    const trimmed = line.trim();

    // Detect plain text lines like if, elif, else, fi, etc.
    const isPlainText =
      /^(if|elif|else|fi)/.test(trimmed) || trimmed.startsWith('echo') || trimmed === '';

    // Detect start of environment block
    if (/if\s*\[\s*\$env\s*==?\s*["']?dev["']?\s*\]/.test(trimmed)) {
      currentEnvGroup = 'dev';
    } else if (/if\s*\[\s*\$env\s*==?\s*["']?sit["']?\s*\]/.test(trimmed)) {
      currentEnvGroup = 'sit';
    } else if (/if\s*\[\s*\$env\s*==?\s*["']?uat["']?\s*\]/.test(trimmed)) {
      currentEnvGroup = 'uat';
    } else if (/else/.test(trimmed)) {
      currentEnvGroup = 'else';
    } else if (/fi/.test(trimmed)) {
      currentEnvGroup = null;
    }

    // Handle key-value pairs (only export lines)
    if (trimmed.startsWith('export') && !isPlainText) {
      const lineWithoutExport = trimmed.replace(/^export\s+/, '');
      let key, value, delimiter;

      if (lineWithoutExport.includes('=')) {
        [key, value] = lineWithoutExport.split('=');
        delimiter = 'equal';
      } else if (lineWithoutExport.includes(':')) {
        [key, value] = lineWithoutExport.split(':');
        delimiter = 'colon';
      }

      if (key && value !== undefined) {
        result.push({
          key: key.trim(),
          value: value.trim(),
          delimiter,
          isPlainText: false,
          envGroup: currentEnvGroup,
          isAPP: key.trim().startsWith('APP_'),
        });
      } else {
        // Handle malformed or empty key-value lines as plain text
        result.push({
          text: trimmed,
          isPlainText: true,
        });
      }
    } else {
      // Handle all non-key-value lines
      result.push({
        text: trimmed,
        isPlainText: true,
        envGroup: currentEnvGroup,
      });
    }
  });

  return result;
}



⸻

Next: I’ll send the updated profileArrayToString that respects the env grouping and plain text. Shall I continue?